name: Test extractions for `hacpsec/specs`

on:
  push:
    branches:
    - '*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: cachix/install-nix-action@v20
    - uses: cachix/cachix-action@v12
      with:
        name: hacspec
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - name: Build
      run: nix build

    - name: Install
      run: |
        nix profile install nixpkgs#yq
        nix profile install .#rustc
        nix profile install .

    - name: Checkout specifications
      uses: actions/checkout@v3
      with:
        repository: 'hacspec/specs'
        
    - name: Test the extraction
      run: |
        paths=$(tomlq -r '.workspace.members | .[]' Cargo.toml)
        for cratePath in $paths; do
          crate=$(tomlq -r '.package.name' "$cratePath/Cargo.toml")
          for skip in $SKIPLIST; do
            if [[ "$skip" == "$crate" ]]; then
              echo "â›” $crate (skipping)"
              continue 2
            fi
          done
          for backend in fstar coq; do
            echo "::group::$crate [$backend]"
            cargo circus -C -p "$crate" \; -i '**' "$backend"
            echo "::endgroup::"
          done
        done
      env:
        SKIPLIST: |
          hacspec-sha256
          hacspec-bls12-381
          hacspec-hmac
          hacspec-bls12-381-hash
          hacspec-gimli
          hacspec-sha3
          hacspec-gf128
          tls_cryptolib
          hacspec-ristretto
          hacspec-linalg
          hacspec-merlin
          hacspec-chacha20poly1305
          hacspec-sha1
          hacspec-ntru-prime
          hacspec-riot-bootloader
          hacspec-riot-runqueue
          hacspec-hkdf
          hacspec-p256
          hacspec-ecdsa-p256-sha256
          hacspec-aes
          hacspec-aes128-gcm
          hacspec-ed25519
          hacspec-edwards25519
          hacspec-edwards25519-hash
          hacspec-edwards25519-ecvrf
          hacspec-rsa-pkcs1
          hacspec-bip-340
          hacspec-rsa-fdh-vrf
          hacspec-xor
          
        
